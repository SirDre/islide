(function ($) {
	$.fn.iSlide = function (c) {
		var c = $.extend(true, $.fn.iSlide.defaults, c);
		return this.each(function () {
			var a = $(this);
			var b = {
				container: a,
				transitionInProgress: false,
				manualTransition: false,
				pausePresentation: false
			};
		 
			iBillboard(c, b);
			if (b.images.length < 2) {
				alert('The "iSlide" widget requires at least four sets of images!');
				return
			}
			initBB(c, b);
			displayBB(c, b);
			initCarrousel(c, b);
			
		})
	};
	
	$.fn.iSlide.defaults = {
		transitionsInterval: 4000,
		transitionsLength: 600
	};
 

 	function initBB(b, c) {
		c.container.append('<div id="bb1"></div><div id="bb2"></div>');
		var d = c.container.find("div");
		
		c.bb1 = $(d[0]);
		c.bb2 = $(d[1]).fadeTo(0, 0);
		c.activeBillboard = c.bb1;
		
		c.titleBar = $(document.createElement("span")).attr({
			"class": "h6"
		});
		
		c.container.append(c.titleBar);
		c.transparentGlass = jQuery(document.createElement("div")).attr("id", "transparentGlass");
		c.container.append(c.transparentGlass);
		c.transparentGlass.click(function (e) {
			var a = c.images[c.images.current].link;
			if (a) document.location.href = c.images[c.images.current].link
		})
	};
	
	function refreshThumb(a, b) {
		var c = b.carrousel.find("li:first");
		var d = b.carrousel.find("li:last");
		b.carrousel.css("top", -c.height() + "px");
		c.before(d)
	}
    
	function imagePointers(a) {
		a.current = (a.current == a.length - 1) ? 0 : a.current + 1;
		a.next = (a.next == a.length - 1) ? 0 : a.next + 1
	};
	
	function onBBTransition(a, b) {

		with(b) if (transitionInProgress || (pausePresentation && manualTransition == false)) return;
		var c = (b.activeBillboard == b.bb1) ? b.bb2: b.bb1;
		var d = b.activeBillboard;
		c.css({
			"background": "url(" + b.images[b.images.next].large + ") no-repeat"
		});
		
		refreshThumb(a, b);
		
		b.carrousel.animate({
			top: "0px"
		},
		a.transitionsLength);
		var w = b.titleBar.width();
		var l = b.titleBar.position().left;
		b.titleBar.animate({
			left: -(l + w) + "px"
		},
		a.transitionsLength / 2, function () {
			b.titleBar.html(b.images[b.images.next].title).css("left", -(b.titleBar.width() + 50) + "px");
			b.titleBar.animate({
				left: l + "px"
			},
			a.transitionsLength / 2)
		});
		b.transitionInProgress = true;
		c.fadeTo(a.transitionsLength, 1);
		d.fadeTo(a.transitionsLength, 0, function () {
			b.activeBillboard = c;
            imagePointers(b.images);
			
			d.css({
				"background": "url(" + b.images[b.images.current].large + ") no-repeat"
			});
			b.transitionInProgress = false
		})
	};	
	
	function iBillboard(e, f) {
		var g = f.container.find("div");
		f.images = [];
		g.each(function (a, b) {
			var c = jQuery(b).find("img");
			var d = jQuery(b).find("a");
			if (c.length >= 2) {
				f.images.push({
					title: $(b).find("span").text(),
					thumb: $(c[0]).attr("src"),
					large: $(c[1]).attr("src"),
					link: $(d[0]).attr("href")
				})
			}
		});
		f.images.current = 0;
		f.images.next = 1;
		g.remove()
	};
	
   function displayBB(a, b) {
		with(b) {
			bb1.css({
				"background": "url(" + images[images.current].large + ") no-repeat"
			});
			bb2.css({
				"background": "url(" + images[images.next].large + ") no-repeat"
			});
			titleBar.html(images[images.current].title)
		}
		b.container.css("display", "block");
		b.billboardIntervalHandle = setInterval(function () {
			onBBTransition(a, b)
		},
		a.transitionsInterval)
	};
	
	function initCarrousel(a, b) {
		b.carrousel = $(document.createElement("ul")).attr("id", "carrousel");
		b.container.append(b.carrousel);
		for (var i = b.images.length - 1; i >= 0; i--) {
			var c = b.images[i];
			var d = '<li style="background:url(' + c.thumb + ') no-repeat"></li>';
			b.carrousel.append(d)
		}
 
		b.downArrow = $(document.createElement("i")).attr({
			"class": "fa fa-arrow-circle-o-down"		
		}).css({
			"opacity": "0"
		}); 
		
		
		b.container.append(b.downArrow);
		b.container.bind("mouseenter mouseleave", function (e) {
			b.downArrow.css("opacity", (e.type == "mouseenter") ? "8": "0")
		});
		b.downArrow.bind("mouseenter mouseleave click", function (e) {
			switch (e.type) {
			case "mouseenter":
				b.pausePresentation = true;
				break;
			case "mouseleave":
				b.pausePresentation = false;
				break;
			case "click":
				if (b.transitionInProgress) return;
				b.manualTransition = true;
				onBBTransition(a, b);
				b.manualTransition = false;
				break
			}
		})
	};



})(jQuery);